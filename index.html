<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üìÖ ‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° (Firebase)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <style>
        body { box-sizing: border-box; height: 100%; margin: 0; font-family: 'Sarabun', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        html { height: 100%; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px; background-color: #e5e7eb; }
        .calendar-day { background-color: white; min-height: 120px; padding: 8px; position: relative; cursor: pointer; } /* Added cursor pointer */
        .calendar-day.other-month { background-color: #f9fafb; color: #9ca3af; cursor: default; } /* Default cursor for other months */
        .calendar-day.today { background-color: #dbeafe; }
        .event-item { background-color: #3b82f6; color: white; padding: 2px 6px; margin: 2px 0; border-radius: 4px; font-size: 11px; cursor: pointer; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); z-index: 1000; }
        .modal.show { display: flex; align-items: center; justify-content: center; }
        /* Simple loading spinner */
        .spinner { border: 4px solid rgba(0, 0, 0, 0.1); width: 36px; height: 36px; border-radius: 50%; border-left-color: #3b82f6; animation: spin 1s ease infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        /* Ensure day number div doesn't block clicks */
        .day-number { pointer-events: none; }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body class="bg-gray-50">
    <div class="container mx-auto p-6 max-w-6xl">
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h1 id="calendar-title" class="text-3xl font-bold text-gray-800 mb-4">‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</h1>
            <div class="flex flex-wrap gap-4 items-center">
                <button id="add-event-btn" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg font-medium transition-colors"> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡πÉ‡∏´‡∏°‡πà </button>
                <div class="flex items-center gap-2">
                    <button id="prev-month" class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-4 py-2 rounded-lg transition-colors"> ‚Üê ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô </button>
                    <span id="current-month" class="text-xl font-semibold text-gray-700 px-4 w-48 text-center"></span> <button id="next-month" class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-4 py-2 rounded-lg transition-colors"> ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ ‚Üí </button>
                </div>
            </div>
             <div class="mt-4 flex flex-wrap gap-4 text-sm">
                <div class="flex items-center gap-2"><div class="w-4 h-4 bg-red-100 border border-red-200 rounded"></div><span class="text-gray-600">üèõÔ∏è ‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£</span></div>
                <div class="flex items-center gap-2"><div class="w-4 h-4 bg-orange-100 border border-orange-200 rounded"></div><span class="text-gray-600">üôè ‡∏ß‡∏±‡∏ô‡∏û‡∏£‡∏∞</span></div>
                <div class="flex items-center gap-2"><div class="w-4 h-4 bg-blue-100 border border-blue-200 rounded"></div><span class="text-gray-600">üìÖ ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</span></div>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h2 class="text-xl font-bold text-gray-800 mb-4">‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏∞‡∏°‡∏≤‡∏ñ‡∏∂‡∏á (7 ‡∏ß‡∏±‡∏ô)</h2>
            <div id="upcoming-events" class="space-y-3">
                 <div class="spinner"></div> </div>
        </div>

        <div class="bg-white rounded-lg shadow-md overflow-hidden">
            <div class="calendar-grid bg-gray-100 text-center font-semibold text-gray-700">
                <div class="p-4">‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå</div> <div class="p-4">‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå</div> <div class="p-4">‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£</div> <div class="p-4">‡∏û‡∏∏‡∏ò</div> <div class="p-4">‡∏û‡∏§‡∏´‡∏±‡∏™‡∏ö‡∏î‡∏µ</div> <div class="p-4">‡∏®‡∏∏‡∏Å‡∏£‡πå</div> <div class="p-4">‡πÄ‡∏™‡∏≤‡∏£‡πå</div>
            </div>
            <div id="calendar-days" class="calendar-grid">
                <div class="col-span-7 p-10 text-center text-gray-500">
                    <div class="spinner"></div> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...
                </div>
            </div>
        </div>
    </div>

    <div id="add-event-modal" class="modal">
        <div class="bg-white rounded-lg p-6 w-full max-w-md mx-4">
            <h2 class="text-xl font-bold text-gray-800 mb-4">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡πÉ‡∏´‡∏°‡πà</h2>
            <form id="add-event-form">
                <div class="mb-4"><label for="event-title" class="block text-sm font-medium text-gray-700 mb-2">‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</label> <input type="text" id="event-title" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"></div>
                <div class="mb-4"><label for="event-date" class="block text-sm font-medium text-gray-700 mb-2">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label> <input type="date" id="event-date" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"></div>
                <div class="mb-4"><label for="event-time" class="block text-sm font-medium text-gray-700 mb-2">‡πÄ‡∏ß‡∏•‡∏≤ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)</label> <input type="time" id="event-time" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"></div>
                <div class="mb-4"><label for="event-description" class="block text-sm font-medium text-gray-700 mb-2">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)</label> <textarea id="event-description" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea></div>
                <div class="mb-6"><label for="event-author" class="block text-sm font-medium text-gray-700 mb-2">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏û‡∏¥‡πà‡∏°</label> <input type="text" id="event-author" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"></div>
                <div class="flex gap-3">
                    <button type="submit" id="save-event-btn" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-lg font-medium transition-colors"> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å </button>
                    <button type="button" id="cancel-event-btn" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-700 py-2 px-4 rounded-lg font-medium transition-colors"> ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å </button>
                </div>
            </form>
        </div>
    </div>

    <div id="event-details-modal" class="modal">
        <div class="bg-white rounded-lg p-6 w-full max-w-md mx-4">
            <h2 class="text-xl font-bold text-gray-800 mb-4">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</h2>
            <div id="event-details-content"></div>
            <div class="flex gap-3 mt-6">
                <button id="delete-event-btn" class="flex-1 bg-red-600 hover:bg-red-700 text-white py-2 px-4 rounded-lg font-medium transition-colors"> ‡∏•‡∏ö‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° </button>
                <button id="close-details-btn" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-700 py-2 px-4 rounded-lg font-medium transition-colors"> ‡∏õ‡∏¥‡∏î </button>
            </div>
        </div>
    </div>

    <script>
        // --- (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î) ‡∏ô‡∏≥ FIREBASE CONFIG ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏°‡∏≤‡∏ß‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà ---
        // --- ‡πÉ‡∏ä‡πâ config ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Å‡∏ï‡πå kusuma-booking ‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢ ---
        const firebaseConfig = {
          apiKey: "PASTE_YOUR_API_KEY_HERE",
          authDomain: "PASTE_YOUR_AUTH_DOMAIN_HERE",
          databaseURL: "PASTE_YOUR_DATABASE_URL_HERE", // ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å
          projectId: "PASTE_YOUR_PROJECT_ID_HERE",
          storageBucket: "PASTE_YOUR_STORAGE_BUCKET_HERE",
          messagingSenderId: "PASTE_YOUR_MESSAGING_SENDER_ID_HERE",
          appId: "PASTE_YOUR_APP_ID_HERE"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const eventsRef = db.ref("calendar_events"); // ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°

        let currentDate = new Date();
        let allEvents = {}; // ‡πÉ‡∏ä‡πâ Object ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Firebase
        let selectedEventKey = null; // ‡πÄ‡∏Å‡πá‡∏ö key ‡∏Ç‡∏≠‡∏á event ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å

        const thaiMonths = ['‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°', '‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå', '‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°', '‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô', '‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°', '‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô', '‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°', '‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°', '‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô', '‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°', '‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô', '‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°'];

        // --- ‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡πÅ‡∏•‡∏∞‡∏ß‡∏±‡∏ô‡∏û‡∏£‡∏∞ (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°) ---
        const thaiHolidays = { '2025-01-01': '‡∏ß‡∏±‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô‡∏õ‡∏µ‡πÉ‡∏´‡∏°‡πà', '2025-02-12': '‡∏ß‡∏±‡∏ô‡∏°‡∏≤‡∏Ü‡∏ö‡∏π‡∏ä‡∏≤', /* ... (‡πÉ‡∏™‡πà‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°) ... */ '2026-12-31': '‡∏ß‡∏±‡∏ô‡∏™‡∏¥‡πâ‡∏ô‡∏õ‡∏µ' };
        const buddhistHolyDays = ['2025-01-06', '2025-01-13', /* ... (‡πÉ‡∏™‡πà‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°) ... */ '2026-12-27'];
        // --- (‡πÉ‡∏™‡πà list ‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡πÅ‡∏•‡∏∞‡∏ß‡∏±‡∏ô‡∏û‡∏£‡∏∞‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏î‡∏¥‡∏°) ---

        // --- Function: Render Calendar ---
        function renderCalendar() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            document.getElementById('current-month').textContent = `${thaiMonths[month]} ${year + 543}`;

            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const daysInMonth = lastDay.getDate();
            const startingDayOfWeek = firstDay.getDay();
            const prevMonthLastDay = new Date(year, month, 0).getDate();

            const calendarDaysEl = document.getElementById('calendar-days');
            calendarDaysEl.innerHTML = ''; // Clear previous days

            // Previous month days
            for (let i = startingDayOfWeek - 1; i >= 0; i--) {
                const dayDiv = createDayElement(prevMonthLastDay - i, true, null); // Pass null for date obj
                calendarDaysEl.appendChild(dayDiv);
            }

            // Current month days
            for (let day = 1; day <= daysInMonth; day++) {
                const dateObj = new Date(year, month, day);
                const dayDiv = createDayElement(day, false, dateObj); // Pass date object
                calendarDaysEl.appendChild(dayDiv);
            }

            // Next month days
            const totalCells = calendarDaysEl.children.length;
            const remainingCells = Math.ceil(totalCells / 7) * 7 - totalCells; // Fill current row
            for (let day = 1; day <= remainingCells; day++) {
                 const dayDiv = createDayElement(day, true, null); // Pass null for date obj
                 calendarDaysEl.appendChild(dayDiv);
            }
             // Ensure 6 rows total if needed
            const currentTotalCells = calendarDaysEl.children.length;
            if (currentTotalCells < 42) {
                 for (let day = remainingCells + 1; day <= remainingCells + 7; day++) {
                     const dayDiv = createDayElement(day - remainingCells, true, null);
                     calendarDaysEl.appendChild(dayDiv);
                 }
            }

            renderUpcomingEvents();
        }

        // --- Function: Create Day Element ---
        function createDayElement(day, isOtherMonth, dateObj) {
            const dayDiv = document.createElement('div');
            dayDiv.className = `calendar-day ${isOtherMonth ? 'other-month' : ''}`;

            let dayLabel = `<div class="font-semibold text-sm mb-1 day-number">${day}</div>`; // Added day-number class
            const dateStr = dateObj ? `${dateObj.getFullYear()}-${String(dateObj.getMonth() + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}` : '';

            if (!isOtherMonth && dateObj) {
                const today = new Date();
                if (dateObj.toDateString() === today.toDateString()) {
                    dayDiv.classList.add('today');
                }

                // Check holidays and holy days
                if (thaiHolidays[dateStr]) {
                    dayLabel += `<div class="text-xs text-red-600 font-medium mb-1 pointer-events-none">üèõÔ∏è ${thaiHolidays[dateStr]}</div>`;
                    dayDiv.style.backgroundColor = '#fef2f2';
                }
                if (buddhistHolyDays.includes(dateStr)) {
                     dayLabel += `<div class="text-xs text-orange-600 font-medium mb-1 pointer-events-none">üôè ‡∏ß‡∏±‡∏ô‡∏û‡∏£‡∏∞</div>`;
                     if (!thaiHolidays[dateStr]) { // Avoid overwriting holiday color
                         dayDiv.style.backgroundColor = '#fff7ed';
                     }
                }

                // Add events
                const dayEvents = getEventsForDateStr(dateStr);
                dayEvents.forEach(([key, event]) => { // Get key and event data
                    const eventDiv = document.createElement('div');
                    eventDiv.className = 'event-item';
                    eventDiv.textContent = event.time ? `${event.time} ${event.title}` : event.title;
                    eventDiv.onclick = (e) => {
                        e.stopPropagation(); // Prevent day click when clicking event
                        showEventDetails(key, event);
                    };
                    dayDiv.appendChild(eventDiv);
                });

                // Click on day to add event
                dayDiv.onclick = () => {
                    document.getElementById('event-date').value = dateStr;
                    showAddEventModal();
                };

            } else {
                 dayDiv.onclick = null; // Disable click for other month days
            }

            dayDiv.innerHTML = dayLabel + dayDiv.innerHTML; // Prepend dayLabel

            return dayDiv;
        }

         // --- Function: Get Events for Date String ---
        function getEventsForDateStr(dateStr) {
            return Object.entries(allEvents).filter(([key, event]) => event.date === dateStr);
        }

        // --- Function: Render Upcoming Events ---
        function renderUpcomingEvents() {
            const upcomingContainer = document.getElementById('upcoming-events');
            const today = new Date();
            today.setHours(0, 0, 0, 0); // Start of today
            const nextWeek = new Date(today.getTime() + 7 * 24 * 60 * 60 * 1000); // End of 7 days from now

            const upcomingEvents = Object.entries(allEvents)
                .map(([key, event]) => ({ key, ...event })) // Include the key
                .filter(event => {
                    const eventDate = new Date(event.date);
                    eventDate.setHours(0,0,0,0); // Ensure comparison at day level
                    return eventDate >= today && eventDate < nextWeek; // Check if within the next 7 days
                })
                .sort((a, b) => {
                     // Sort by date, then by time if available
                     const dateA = new Date(a.date + (a.time ? `T${a.time}` : 'T00:00:00'));
                     const dateB = new Date(b.date + (b.time ? `T${b.time}` : 'T00:00:00'));
                     return dateA - dateB;
                 });

            if (upcomingEvents.length === 0) {
                upcomingContainer.innerHTML = '<p class="text-gray-500 text-center py-4">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏°‡∏≤‡∏ñ‡∏∂‡∏á‡πÉ‡∏ô 7 ‡∏ß‡∏±‡∏ô‡∏Ç‡πâ‡∏≤‡∏á‡∏´‡∏ô‡πâ‡∏≤</p>';
                return;
            }

            upcomingContainer.innerHTML = upcomingEvents.map(event => {
                const eventDate = new Date(event.date);
                const formattedDate = `${eventDate.getDate()} ${thaiMonths[eventDate.getMonth()]}`;
                 const tomorrow = new Date(today.getTime() + 24 * 60 * 60 * 1000);

                let dateLabel = formattedDate;
                if (eventDate.toDateString() === today.toDateString()) dateLabel = '‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ';
                else if (eventDate.toDateString() === tomorrow.toDateString()) dateLabel = '‡∏û‡∏£‡∏∏‡πà‡∏á‡∏ô‡∏µ‡πâ';

                return `
                    <div class="flex items-start justify-between p-3 bg-blue-50 rounded-lg border-l-4 border-blue-500 cursor-pointer hover:bg-blue-100" onclick='showEventDetails("${event.key}", ${JSON.stringify(event).replace(/'/g, "\\'")})'>
                        <div class="flex-1 mr-4">
                            <div class="font-semibold text-gray-800">${event.title}</div>
                            <div class="text-sm text-gray-600">${dateLabel}${event.time ? ` ‡πÄ‡∏ß‡∏•‡∏≤ ${event.time}` : ''}</div>
                            ${event.description ? `<div class="text-sm text-gray-500 mt-1">${event.description}</div>` : ''}
                        </div>
                        <div class="text-xs text-gray-500 text-right whitespace-nowrap">‡πÇ‡∏î‡∏¢ ${event.author}</div>
                    </div>
                `;
            }).join('');
        }

        // --- Modal Functions ---
        function showAddEventModal() { document.getElementById('add-event-modal').classList.add('show'); document.getElementById('event-title').focus(); }
        function hideAddEventModal() { document.getElementById('add-event-modal').classList.remove('show'); document.getElementById('add-event-form').reset(); }
        function showEventDetails(key, event) {
            selectedEventKey = key; // Store the key
            const content = document.getElementById('event-details-content');
            const eventDate = new Date(event.date);
            const formattedDate = `${eventDate.getDate()} ${thaiMonths[eventDate.getMonth()]} ${eventDate.getFullYear() + 543}`;
            content.innerHTML = `<div class="space-y-3"><div><span class="font-semibold text-gray-700">‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°:</span> <p class="text-gray-800">${event.title}</p></div><div><span class="font-semibold text-gray-700">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</span> <p class="text-gray-800">${formattedDate}</p></div>${event.time ? `<div><span class="font-semibold text-gray-700">‡πÄ‡∏ß‡∏•‡∏≤:</span> <p class="text-gray-800">${event.time}</p></div>` : ''}${event.description ? `<div><span class="font-semibold text-gray-700">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î:</span> <p class="text-gray-800">${event.description}</p></div>` : ''}<div><span class="font-semibold text-gray-700">‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏î‡∏¢:</span> <p class="text-gray-800">${event.author}</p></div></div>`;
            document.getElementById('event-details-modal').classList.add('show');
        }
        function hideEventDetails() { document.getElementById('event-details-modal').classList.remove('show'); selectedEventKey = null; }

        // --- Firebase Functions ---
        async function addEventToFirebase(eventData) {
            const saveBtn = document.getElementById('save-event-btn');
            saveBtn.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...'; saveBtn.disabled = true;

            try {
                await eventsRef.push({
                    title: eventData.title,
                    date: eventData.date,
                    time: eventData.time || null, // Store null if no time
                    description: eventData.description || null, // Store null if no description
                    author: eventData.author,
                    created_at: firebase.database.ServerValue.TIMESTAMP // Use server timestamp
                });
                hideAddEventModal();
                showMessage('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß', 'success');
            } catch (error) {
                console.error("Error adding event:", error);
                showMessage('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', 'error');
            } finally {
                 saveBtn.textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å'; saveBtn.disabled = false;
            }
        }

        async function deleteEventFromFirebase() {
            if (!selectedEventKey) return;
            if (!confirm('‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ô‡∏µ‡πâ?')) return; // Confirmation

            const deleteBtn = document.getElementById('delete-event-btn');
            deleteBtn.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏ö...'; deleteBtn.disabled = true;

            try {
                await eventsRef.child(selectedEventKey).remove();
                hideEventDetails();
                showMessage('‡∏•‡∏ö‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß', 'success');
            } catch (error) {
                console.error("Error deleting event:", error);
                showMessage('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', 'error');
            } finally {
                 deleteBtn.textContent = '‡∏•‡∏ö‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°'; deleteBtn.disabled = false;
            }
        }

        // --- Helper: Show Message ---
        function showMessage(message, type) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `fixed top-4 right-4 px-6 py-3 rounded-lg text-white z-[1001] ${type === 'success' ? 'bg-green-600' : 'bg-red-600'}`;
            messageDiv.textContent = message;
            document.body.appendChild(messageDiv);
            setTimeout(() => { messageDiv.remove(); }, 3000);
        }

        // --- Event Listeners ---
        document.getElementById('add-event-btn').onclick = showAddEventModal;
        document.getElementById('cancel-event-btn').onclick = hideAddEventModal;
        document.getElementById('close-details-btn').onclick = hideEventDetails;
        document.getElementById('delete-event-btn').onclick = deleteEventFromFirebase; // Changed to Firebase delete
        document.getElementById('prev-month').onclick = () => { currentDate.setMonth(currentDate.getMonth() - 1); renderCalendar(); };
        document.getElementById('next-month').onclick = () => { currentDate.setMonth(currentDate.getMonth() + 1); renderCalendar(); };
        document.getElementById('add-event-form').onsubmit = (e) => {
            e.preventDefault();
            addEventToFirebase({ // Changed to Firebase add
                title: document.getElementById('event-title').value.trim(),
                date: document.getElementById('event-date').value,
                time: document.getElementById('event-time').value,
                description: document.getElementById('event-description').value.trim(),
                author: document.getElementById('event-author').value.trim()
            });
        };
        // Close modals on outside click
        document.getElementById('add-event-modal').onclick = (e) => { if (e.target.id === 'add-event-modal') hideAddEventModal(); };
        document.getElementById('event-details-modal').onclick = (e) => { if (e.target.id === 'event-details-modal') hideEventDetails(); };

        // --- Firebase Listener ---
        eventsRef.on('value', (snapshot) => {
            allEvents = snapshot.val() || {}; // Update events from Firebase
            console.log("Data from Firebase:", allEvents); // Log data for debugging
            renderCalendar(); // Re-render the calendar with new data
        }, (error) => {
             console.error("Firebase read failed:", error);
             document.getElementById('calendar-days').innerHTML = '<div class="col-span-7 p-10 text-center text-red-600">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô</div>';
             document.getElementById('upcoming-events').innerHTML = '<div class="p-10 text-center text-red-600">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</div>';
        });

    </script>
</body>
</html>
